---
title: 'Energy Consumption: Make It Or Break It!'
author: "Corey Dow-Hygelund"
output:
  html_document:
    df_print: paged
---

# Description
**Purpose** To determine if the internal Firefox metrics can be utilized as a proxy for battery drain in the extreme cases. The idea is to investigate if there is a relationship between the metrics and battery drain for cases where   ... (known high and low usage) 

A suite of experiments were performed, which only differed on website


1. Fire up Firefox in Marionette mode
2. Wait 5 minutes
3. Go to website
4. Wait 10 minutes
5. Stop experiment

```{r echo=FALSE, message=FALSE}
library(jsonlite)
library(lubridate)
library(stringr)
library(ggplot2)
library(plyr)

parse_counters_sum <- function(file_path){
  counters <- read_json(file_path)
  df <- data.frame(timestamp=as.POSIXct(character()), seconds=integer(), duration=integer(), counters=integer())
  for (counter in counters){
    duration <- 0
    counts <- 0
    for (tab in counter$tabs) {
      duration = duration + tab$duration
      counts = counts + tab$dispatchCount
    }
    timestamp <- hms(str_split(ymd_hms(counter$timestamp), ' ')[[1]][2])
    seconds <- hour(timestamp)*60*60 + minute(timestamp)*60 + second(timestamp)
    df <- rbind(df, list(timestamp=ymd_hms(counter$timestamp), seconds=seconds, 
                duration=duration, counts=counts))
  }
  return(df)
}

parse_ipg <- function(file_path){
  df <- read.csv(file_path, stringsAsFactors = FALSE)
  clean_time <- hms(str_extract(df$System.Time, '^[0-9]+:[0-9]+:[0-9]+'))
  df$seconds <- (hour(clean_time))*60*60+minute(clean_time)*60+second(clean_time)
  return(df)
}

get_action <- function(file_path){
  log <- read_json(file_path)
  log <- ldply(log, data.frame, stringsAsFactors=FALSE)
  action <- log$action[3]
  timestamp = hms(str_split(ymd_hms(log$timestamp[3]), ' ')[[1]][2])
  seconds <- hour(timestamp)*60*60 + minute(timestamp)*60 + second(timestamp)
  return(list(action=action, seconds=seconds))
}

parse_log <- function(file_path){
  log <- read_json(file_path)
  log <- ldply(log, data.frame, stringsAsFactors=FALSE)
  return(log)
}


get_data <- function(counter_file_path, ipg_file_path){
  df.counter <- parse_counters_sum(counter_file_path)
  df.ipg <- parse_ipg(ipg_file_path)

  final <- merge(df.counter, df.ipg, by='seconds')
  final$stopwatch <- final$seconds - final$seconds[1]
  return(final)
}
  
plot_data <- function(df, log=NULL, add_fit=TRUE){
  a <- ggplot(df, aes(stopwatch, Cumulative.Processor.Energy_0.mWh.)) + 
    geom_line() + 
    geom_point()
  b <- ggplot(df, aes(stopwatch, counts)) + 
    geom_line() + 
    geom_point()
  c <- ggplot(df, aes(counts, Cumulative.Processor.Energy_0.mWh.)) + 
    geom_line() + 
    geom_point()
  if(!missing(log)){
    idx = df$stopwatch[df$seconds==log$seconds]
    idx_pwr = df$Cumulative.Processor.Energy_0.mWh.[df$seconds==log$seconds]
    a <- a + 
      geom_text(x=idx, y=0.75*max(df$Cumulative.Processor.Energy_0.mWh.), 
              label=log$action, color='blue') + 
      geom_vline(xintercept = idx, linetype='dashed', color='red')
    b <- b + 
      geom_text(x=idx, y=0.75*max(df$counts), 
              label=log$action, color='blue') + 
      geom_vline(xintercept = idx, linetype='dashed', color='red')
    c <- c + 
      geom_text(x=idx, y=0.75*max(df$Cumulative.Processor.Energy_0.mWh.), 
              label=log$action, color='blue') + 
      geom_vline(xintercept = idx, linetype='dashed', color='red')
  }
  if(add_fit){
    a <- a +
      geom_smooth(method='lm')
  }
  print(a)
  print(b)
  print(c)
}

plot_clean_data <- function(df, log){
  idx = df$stopwatch[df$seconds==log$seconds]
  a <- ggplot(df, aes(stopwatch, CPU.Processor.Energy.Excess)) + 
    geom_line() + 
    geom_point() +
    geom_text(x=idx, y=0.75*max(df$CPU.Processor.Energy.Excess), 
              label=log$action, color='blue') + 
      geom_vline(xintercept = idx, linetype='dashed', color='red')
  c <- ggplot(df, aes(counts, CPU.Processor.Energy.Excess)) + 
    geom_line() + 
    geom_point() + 
      geom_text(x=idx, y=0.75*max(df$CPU.Processor.Energy.Excess), 
              label=log$action, color='blue') + 
      geom_vline(xintercept = idx, linetype='dashed', color='red')
  print(a)
  print(c)
}

remove_bg <- function(df, log){
  model <- lm(Cumulative.Processor.Energy_0.mWh. ~ stopwatch, df[df$seconds<log$seconds, ])
  cleaned <- df$Cumulative.Processor.Energy_0.mWh.- predict(model, df)
  return(cleaned)
}
```


```{r echo=FALSE}
root_dir = '/Users/chygelund/PycharmProjects/FF-power-consumption/Energy_Consumption/experiments/intel_pg_battery_report/data/make_or_break/'
```
# Experiment: None
## about:home
No website navigation occurred. 

```{r echo=FALSE}
counter_file_path <- file.path(root_dir, 'none/run 2/Experiment - V0 - none_7_perf_counters.json')
ipg_file_path <- file.path(root_dir, 'none/run 2/ipg_7_1_clean.txt')
df <- get_data(counter_file_path, ipg_file_path)
log <- get_action(file.path(root_dir, 'none/run 2/Experiment - V0 - none_7_experiment.json'))
```

### Raw Values
```{r echo=FALSE}
plot_data(df)
```

Processor energy ~ time linear fit (Blue line)
```{r echo=FALSE}
lm(Cumulative.Processor.Energy_0.mWh. ~ stopwatch, df)
```

# Experiment: Low
## www.google.com

```{r echo=FALSE}
counter_file_path <- file.path(root_dir, 'low/run 2/Experiment - V0 - low_6_perf_counters.json')
ipg_file_path <- file.path(root_dir, 'low/run 2/ipg_6_1_clean.txt')
log <- get_action(file.path(root_dir, 'low/run 2/Experiment - V0 - low_6_experiment.json'))
df <- get_data(counter_file_path, ipg_file_path)
df$CPU.Processor.Energy.Excess <- remove_bg(df, log)
```

## Raw Values
```{r echo=FALSE}
plot_data(df, log)
```

### Baseline Corrected
Remove background energy usage:

* fit a linear model to data before website navigation
* Subtract linear model predicted values from CPU energy usage

```{r echo=FALSE}
plot_clean_data(df, log)
```

Processor energy ~ time linear fit (Blue line)
```{r echo=FALSE}
lm(Cumulative.Processor.Energy_0.mWh. ~ stopwatch, df)
```
# Experiment: Medium
## www.slate.com

```{r echo=FALSE}
counter_file_path <- file.path(root_dir, 'medium/run 1/Experiment - V0 - high 2_8_perf_counters.json')
ipg_file_path <- file.path(root_dir, 'medium/run 1/ipg_8_1_clean.txt')
df <- get_data(counter_file_path, ipg_file_path)
log <- get_action(file.path(root_dir, 'medium/run 1/Experiment - V0 - high 2_8_experiment.json'))
df$CPU.Processor.Energy.Excess <- remove_bg(df, log)
```

## Raw Values
```{r echo=FALSE}
plot_data(df, log)
```

### Baseline Corrected
```{r echo=FALSE}
plot_clean_data(df, log)
```

Processor energy ~ time linear fit: Before navigation
```{r echo=FALSE}
idx = df$stopwatch[df$seconds==log$seconds]
lm(Cumulative.Processor.Energy_0.mWh. ~ stopwatch, df[df$seconds<log$seconds, ])
```
Processor energy ~ time linear fit: After navigation
```{r echo=FALSE}
lm(Cumulative.Processor.Energy_0.mWh. ~ stopwatch, df[df$seconds>log$seconds, ])
```

# Experiment: High
## www.lingscars.com

```{r echo=FALSE}
counter_file_path <- file.path(root_dir, 'high/run 1/Experiment - V0 - high_5_perf_counters.json')
ipg_file_path <- file.path(root_dir, 'high/run 1/ipg_5_1_clean.txt')
df <- get_data(counter_file_path, ipg_file_path)
log <- get_action(file.path(root_dir, 'high/run 1/Experiment - V0 - high_5_experiment.json'))
df$CPU.Processor.Energy.Excess <- remove_bg(df, log)
```

## Raw Values
```{r echo=FALSE}
plot_data(df, log, add_fit=FALSE)
```

### Baseline Corrected
```{r echo=FALSE}
plot_clean_data(df, log)
```

Processor energy ~ time linear fit: Before navigation
```{r echo=FALSE}
idx = df$stopwatch[df$seconds==log$seconds]
lm(Cumulative.Processor.Energy_0.mWh. ~ stopwatch, df[df$seconds<log$seconds, ])
```
Processor energy ~ time linear fit: After navigation
```{r echo=FALSE}
lm(Cumulative.Processor.Energy_0.mWh. ~ stopwatch, df[df$seconds>log$seconds, ])
```

# Experiment: Combo
## www.mozilla.com, www.twitch.com, www.twitch.tv/directory/game/Fortnite, https://addons.mozilla.org/en-US/firefox/

Experimental run parameters differ from the above:


1. Fire up Firefox in Marionette mode
2. Wait 2 minutes
3. Go to www.mozilla.com
4. Wait 2 minutes
5. Go backwards
6. Wait 2 minutes
7. Go forward (back on www.mozilla.com)
8. Wait 30 seconds
9. Go to www.twitch.com
10. Wait 2 minutes
11. Go to www.twitch.tv/directory/game/Fortnite
12. Wait 2 minutes
13. Go to https://addons.mozilla.org/en-US/firefox/
14. Go backwards
15. Go forwards
16. Wait 2 minutes
17. Stop experiment



```{r echo=FALSE}
counter_file_path <- file.path(root_dir, 'combo/run 1/Experiment - V0 - combo_9_perf_counters.json')
ipg_file_path <- file.path(root_dir, 'combo/run 1/ipg_9_1_clean.txt')
df <- get_data(counter_file_path, ipg_file_path)
log <- get_action(file.path(root_dir, 'combo/run 1/Experiment - V0 - combo_9_experiment.json'))
df$CPU.Processor.Energy.Excess <- remove_bg(df, log)
```

## Raw Values
```{r echo=FALSE}
plot_data(df, log, add_fit=FALSE)
```

### Baseline Corrected
```{r echo=FALSE}
plot_clean_data(df, log)
```

# Observations
The slope of processor energy with respect to time (seconds) is consistently ~0.5 for all experiments, save the high experiment upon navigation to the website. This suggests a significant baseline/background CPU power usage.

For the experiments, there is a relationship between the CPU power consumption and the performance counters, after correcting for the baseline power usage. The increase in the power consumption after website navigation, is attributable to the increase in the counters. 
